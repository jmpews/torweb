function monitor_system_status(){$.ajax({type:"get",dataType:"json",url:"/api/systemstatus",success:function(e,t){if(0==e.errorcode){var e=e.data;$(".cpu-per").html(e.cpu_per+"%"),$(".ram-per").html(e.ram_per+"%"),$(".net-conn").html(e.net_conn),$(".os-start").html(e.os_start)}}}),setTimeout(monitor_system_status,6e4)}function change_theme(){$(".color").on("click",function(e){var t=$(e.target).attr("color");$.cookie("theme",t,{expires:30}),$.ajax({type:"post",dataType:"json",url:"/useropt",data:JSON.stringify({opt:"update-theme",data:{theme:t}}),success:function(e,t){0==e.errorcode?$.notify("主题保存成功"):e.errorcode==-3&&$("#loginModal").modal("toggle")}}),$("#theme").attr("href","/assets/css/index."+t+".css")})}function set_theme(){var e=$.cookie("theme");e&&$("#theme").attr("href","/assets/css/index."+e+".css")}function change_image_preview(){$inputFileElm=$(this);var e=document.getElementById("avatar-cropper"),t=document.getElementById("avatar");console.log(e),console.log(t);var a=t.value.substring(t.value.lastIndexOf(".")+1).toLowerCase();if("png"!=a&&"jpg"!=a&&"jpeg"!=a)return void alert("文件必须为图片！");if(t.size>3072e3)return void alert("上传图片不要超过3000KB");if(document.all){t.select();var o=document.selection.createRange().text,n=/msie 6/i.test(navigator.userAgent);n?e.src=o:(e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image',src=\""+o+'")',e.src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")}else{var r=t.files[0],i=new FileReader;i.readAsDataURL(r),i.onload=function(t){e.src=this.result,$(e).cropper("reset").cropper("replace",this.result)}}$inputFileElm.val("")}function html5Reader(e){var e=e.files[0],t=new FileReader;t.readAsDataURL(e),t.onload=function(e){var t=document.getElementById("avatar-cropper");t.src=this.result}}function show_hide_cate_nav(){$(".card-header-all-bt, .card-header:after").mouseenter(function(e){$(".card-header-all").fadeIn(500)}),$(".card-header-all").parent().mouseleave(function(e){$(".card-header-all").css("display","none")})}function post_new_show_hide_cate(){$(".post-new-html #topic").on("click",function(e){$(".card-header-all").css("display","block")}),$(".post-new-html .card-header-all-cate a").on("click",function(e){$(".card-header-all").css("display","none"),$("#topic").val($(this).html())})}function show_hide_emoji_list(){$("#emoji-btn").on("mousedown",function(e){$("#summernote").summernote("saveRange")}).on("click",function(e){e.preventDefault(),e.stopPropagation(),$("#emoji-list").css("display","block")})}function show_hide_emoji_list_medium(){$("#emoji-btn").on("click",function(e){e.preventDefault(),e.stopPropagation(),$("#emoji-list").css("display","block")})}function add_action_emoji_img_medium(){$("#emoji-list img.emoji").on("click",function(e){var t=$("#mediumeditor");t.append('<img src="'+e.target.src+'" class="emoji">')})}function add_action_emoji_char_medium(){$("#emoji-list li.emoji").on("click",function(e){var t=$("#mediumeditor");t.append('<span class="emoji">'+window.emojiJSON[e.target.attributes.em.value].char+"</span>")})}function load_emoji_medium(){for(var e=["smile","blush","grin","heart_eyes","relaxed","sweat_smile","joy","flushed","confused","unamused","sob","cold_sweat","sweat","scream","sleepy","mask"],t=0;t<e.length;t++)$("#emoji-list").append('<img class="emoji" src="/assets/images/emoji/basic/'+e[t]+'.png">');add_action_emoji_img_medium(),$.getJSON("/assets/images/emoji/emojis.json",function(e){window.emojiJSON=e,$("#emoji-list").append('<li class="emoji" em="heart">'+emojiJSON.heart.char+"</li>"),add_action_emoji_char_medium()})}function load_font_avatar(){var e=["#FF5722","#CDDC39","#61C5FF","#2196F3"];$(".post-avatar a span").each(function(t,a){var o=e[Math.floor(Math.random()*e.length)];$(a).css("background-color",o)})}function getFriendlyTime(e){if(e=e.replace("-","/"),e=e.replace("-","/"),console.log(e),!e)return"biu...";var t=Date.now()-Date.parse(e),a=6e4,o=36e5,n=864e5,r=6048e5,i=2592e6,s=31536e6;return t<2*a?"A moment ago":t<o?Math.floor(t/a)+" mins ago":t<n?1==Math.floor(t/o)?"an hour ago":Math.floor(t/o)+" hrs ago":t<r?1==Math.floor(t/n)?"yesterday":Math.floor(t/n)+" days ago":t<i?1==Math.floor(t/r)?"last week":Math.floor(t/r)+" weeks ago":t<s?1==Math.floor(t/i)?"last month":Math.floor(t/i)+" months ago":1==Math.floor(t/s)?"an year ago":Math.floor(t/s)+" yrs ago"}function replate_friendly_time(){$(".friendly-time").each(function(e,t){$(t).html(getFriendlyTime($(t).html()))})}function extractDomain(e){var t;return t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]}function get_websocket_url(e){$.ajax({type:"get",dataType:"json",url:"/api/websocketurl",success:function(t){if(0==t.errorcode){var a=t.data.url;"."==a&&(a=extractDomain(window.location.href)),e(a),console.log("get websocket url success. and start websocket.")}else 0!=t.errorcode&&console.log("get websocket url error.")}})}function start_system_monitor_websocket(e){function t(e){console.log("Connected to WebSocket server.")}function a(e){console.log("Disconnected")}function o(e){var t=JSON.parse(e.data).data;$(".cpu-per").html(t.cpu_per+"%"),$(".ram-per").html(t.ram_per+"%"),$(".net-conn").html(t.net_conn),$(".os-start").html(t.os_start)}function n(e){console.log("Error occured: "+e.data)}var r="ws://"+e+"/api/systemstatuswebsocket";sys_websocket=new WebSocket(r),sys_websocket.onopen=function(e){t(e)},sys_websocket.onclose=function(e){a(e)},sys_websocket.onmessage=function(e){o(e)},sys_websocket.onerror=function(e){n(e)}}function start_chat_websocket(e){function t(e){console.log("Connected to WebSocket server."),window.sessionStorage.setItem("current_other","")}function a(e){console.log("Disconnected")}function o(e){var t=JSON.parse(e.data);if(console.log(t),0==t.errorcode){var a=JSON.parse(e.data).data,o=a.user_id,n=window.sessionStorage.getItem(a.user_id);console.log("r",a,n),n?cache_chat_log(a,chat_init):get_chat_log(o,chat_init)}else if(1==t.errorcode){var a=JSON.parse(e.data).data,o=a.user_id,n=window.sessionStorage.getItem(a.user_id);console.log("s",a,n),n?cache_chat_log(a,chat_init):get_chat_log(o,chat_init)}else 2==t.errorcode?$.notify("未在线,等待上线回复."):3==t.errorcode||0!=t.errorcode&&alert(t.txt)}function n(e){console.log("Error occured: "+e.data)}var r="ws://"+e+"/user/chatwebsocket";chat_websocket=new WebSocket(r),chat_websocket.onopen=function(e){t(e)},chat_websocket.onclose=function(e){a(e)},chat_websocket.onmessage=function(e){o(e)},chat_websocket.onerror=function(e){n(e)}}function cache_chat_log(e,t){var a=window.sessionStorage.getItem(e.user_id);a=JSON.parse(a),a.logs.push(e.data),window.sessionStorage.setItem(e.user_id,JSON.stringify(a)),t(a)}function get_chat_log(e,t){$.ajax({type:"post",dataType:"json",url:"/useropt",data:JSON.stringify({opt:"realtime-chat",data:{other:e}}),success:function(a,o){if(0==a.errorcode){var n=a.data;window.sessionStorage.setItem(e,JSON.stringify(n)),t(n)}else{if(a.errorcode==-3)return $.notify(a.txt),!1;if(0!=a.errorcode)return $.notify(a.txt),!1}}})}function chat_init(e){if(console.log(e),e){$(".chat .chat-header").html("chat 2 "+e.me),$(".chat .chat-header").attr("other_avatar",e.other_avatar),$(".chat .chat-header").attr("me_avatar",e.me_avatar);var t=e.logs,a=$(".chat .chat-content ul");$(a).html("");for(var o=0;o<t.length;o++){if("<"==t[o][0])var n="<li class='chat-other cl'><img class='avatar' src='/assets/images/avatar/"+e.other_avatar+"'><div class='chat-text'>"+t[o][1]+"</div></li>";else var n="<li class='chat-self cl'><img class='avatar' src='/assets/images/avatar/"+e.me_avatar+"'><div class='chat-text'>"+t[o][1]+"</div></li>";$(a).append(n)}$(".chat-container").show()}}$(document).on("mouseover",".dropdown",function(){$(this).find(".dropdown-menu").show()}),$(document).on("mouseout",".dropdown",function(){$(this).find(".dropdown-menu").hide()});var $this,$ajaxUrl="";$.fn.pasteUploadImage=function(e){$this=$(this),$host=e,$this.on("paste",function(e){console.log("paste...");var t,a,o,n;if(o=e.originalEvent,o.clipboardData&&o.clipboardData.items&&(a=isImage(o)))return e.preventDefault(),t=getFilename(o)||"image.png",n="{{"+t+"(uploading...)}}",pasteText(n),uploadFile(a.getAsFile(),t)}),$this.on("drop",function(e){console.log("drop...");var t,a,o,n;if(o=e.originalEvent,o.dataTransfer&&o.dataTransfer.files&&(a=isImageForDrop(o)))return e.preventDefault(),t=o.dataTransfer.files[0].name||"image.png",n="{{"+t+"(uploading...)}}",pasteText(n),uploadFile(a,t)})},pasteText=function(e){var t,a,o,n,r;return n=$this[0].selectionStart,o=$this[0].selectionEnd,r=$this.val().length,a=$this.val().substring(0,n),t=$this.val().substring(o,r),$this.val(a+e+t),$this.get(0).setSelectionRange(n+e.length,o+e.length),$this.trigger("input")},isImage=function(e){var t,a;for(t=0;t<e.clipboardData.items.length;){if(a=e.clipboardData.items[t],a.type.indexOf("image")!==-1)return a;t++}return!1},isImageForDrop=function(e){var t,a;for(t=0;t<e.dataTransfer.files.length;){if(a=e.dataTransfer.files[t],a.type.indexOf("image")!==-1)return a;t++}return!1},getFilename=function(e){var t;return window.clipboardData&&window.clipboardData.getData?t=window.clipboardData.getData("Text"):e.clipboardData&&e.clipboardData.getData&&(t=e.clipboardData.getData("text/plain")),t=t.split("\r"),t[0]},getMimeType=function(e,t){var a=e.type,o=t.substring(t.lastIndexOf(".")+1);return a!="image/"+o?"image/"+o:a},uploadFile=function(e,t){var a=new FormData;a.append("imageFile",e),a.append("mimeType",getMimeType(e,t)),$.ajax({url:$ajaxUrl,data:a,type:"post",processData:!1,contentType:!1,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return e.success?insertToTextArea(t,e.message):replaceLoadingTest(t)},error:function(e,a){replaceLoadingTest(t),console.log(e.responseText)}})},insertToTextArea=function(e,t){return $this.val(function(a,o){return o.replace("{{"+e+"(uploading...)}}","!["+e+"]("+t+")\n")})},replaceLoadingTest=function(e){return $this.val(function(t,a){return a.replace("{{"+e+"(uploading...)}}",e+"\n")})},$('#loginModal [type="submit"]').on("click",function(e){return e.preventDefault(),$.ajax({type:"post",dataType:"json",url:"/login",data:{username:$("#loginModal #username").val(),password:$("#loginModal #password").val(),captcha:$("#loginModal #captcha").val()},success:function(e,t){if(0==e.errorcode){e.data;$.notify("登陆成功"),window.location.reload()}else e.errorcode==-3?($.notify(e.txt),$("#captcha").val("")):0!=e.errorcode&&$.notify(e.txt)}}),1}),$(".captcha").on("click",function(e){e.preventDefault();var t=$(e.currentTarget).attr("src"),a=t.indexOf("?");a!=-1&&(t=t.substring(0,a)),t=t+"?id="+Math.random(1).toString(),$(e.currentTarget).attr("src",t)}),$(document).click(function(e){$(".chat-container").on("click",function(e){e.stopPropagation()}),$(".chat-container").is(":hidden")||($(".chat-container").hide(),$("#emoji-list").is(":hidden")||$("#emoji-list").hide())}),$(document).ready(function(){change_theme(),load_font_avatar()});